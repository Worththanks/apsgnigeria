<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members - APSG Admin</title>
    
    <!-- Favicon (added multiple sizes for better mobile/browser support without affecting colors) -->
  <link rel="icon" href="/assets/images/apsg.png" sizes="any" />
  <link rel="apple-touch-icon" href="/assets/images/apsg.png" />
  
    <!-- Prevent flash of wrong theme -->
    <script>
        if (localStorage.getItem("daynight-theme") === "carbon") {
            document.documentElement.classList.add("carbon");
        }
    </script>
    <link rel="stylesheet" href="/assets/css/styles.css">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay"></div>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-menu-header">
            <a href="dashboard.html" class="logo">
                <img src="/assets/images/apsg.png" alt="APSG Logo">
                APSG Admin
            </a>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="dashboard.html">
                <i class="fas fa-gauge-high"></i>
                Dashboard
            </a>
            <a href="members.html" class="active">
                <i class="fas fa-users"></i>
                Members
            </a>
        </nav>
        <div class="mobile-menu-footer">
            <a class="mobile-logout-btn" style="cursor:pointer;">
                <i class="fas fa-arrow-right-from-bracket"></i>
                Logout
            </a>
        </div>
    </div>

   
<div class="app-container">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="dashboard.html" class="logo">
                 
                    APSG Admin
                </a>
                    <div class="nav-menu">
                        <div class="nav-item">
                            <a href="dashboard.html" class="nav-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                                </svg>
                                Dashboard
                            </a>
                        </div>
                        <div class="nav-item">
                            <a href="members.html" class="nav-link active">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4-4v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                Members
                            </a>
                        </div>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="theme-toggle">
                        <button class="theme-btn theme-btn-snow active" onclick="setTheme('snow')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </button>
                        <button class="theme-btn theme-btn-carbon" onclick="setTheme('carbon')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                    </div>
                    <button class="btn-logout" style="cursor:pointer;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>


        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Registered Members</h1>
                    <p class="page-subtitle">Full list of APC Progressive Support Group (APSG) members with PVC and APC Membership Card</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>Total Members: <strong id="totalMembers">0</strong></div>
                    <button id="exportCsv" class="btn btn-success btn-sm d-flex align-items-center gap-2">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="membersTable" class="table table-hover mb-0" style="width:100%">
                            <thead class="table-dark">
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>State</th>
                                    <th>LGA</th>
                                    <th>Ward</th>
                                    <th>PVC #</th>
                                    <th>APC Card #</th>
                                    <th>PVC Upload</th>
                                    <th>APC Upload</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>

            <!-- No Data Message -->
            <div id="noDataMessage" class="text-center mt-5" style="display:none;">
                <p class="text-muted fs-4">No members registered yet.</p>
            </div>
        </main>

        <footer class="footer">
            <p>Â© 2026 APSG Nigeria Admin Dashboard</p>
        </footer>
    </div>

    <!-- Document Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Document Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <iframe id="previewFrame" style="width:100%;height:75vh;border:none;"></iframe>
                    <img id="previewImage" src="" class="img-fluid d-none" style="max-height:75vh;">
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery & DataTables -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Shared Supabase Auth & Client -->
    <script src="/assets/js/supabase-clients.js"></script>

    <!-- Members Page Script -->
    <script>
        async function checkAuth() {
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                window.location.href = 'login.html';
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        document.querySelectorAll('.mobile-logout-btn, .btn-logout').forEach(el => {
            el.addEventListener('click', logout);
        });

        async function loadMembers() {
            const { data: members, error } = await supabaseClient
                .from('members')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Load error:', error);
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            document.getElementById('totalMembers').textContent = members.length;

            if (members.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            const table = $('#membersTable').DataTable({
                data: members,
                dom: 'Bfrtip',
                buttons: [{ extend: 'csv', text: 'Export CSV', className: 'btn btn-success btn-sm' }],
                pageLength: 25,
                responsive: true,
                columnDefs: [{ targets: [7,8,10], orderable: false }],
                columns: [
                    { data: 'full_name', title: 'Name' },
                    { data: 'phone', title: 'Phone' },
                    { data: 'state', title: 'State' },
                    { data: 'lga', title: 'LGA' },
                    { data: 'ward', title: 'Ward' },
                    { data: 'pvc_number', title: 'PVC #' },
                    { data: 'apc_card_number', title: 'APC Card #' },
                    { data: 'pvc_upload_path', title: 'PVC Upload', render: renderUpload },
                    { data: 'apc_upload_path', title: 'APC Upload', render: renderUpload },
                    { data: 'created_at', title: 'Date', render: d => new Date(d).toLocaleDateString('en-NG') },
                    { data: null, title: 'Actions', render: (data, type, row) => `
                        <div class="d-flex gap-2">
                            <a href="member-details.html?id=${row.id}" class="btn btn-primary btn-sm">View</a>
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${row.id}">Delete</button>
                        </div>
                    ` }
                ]
            });

            function renderUpload(path) {
                if (!path) return '<span class="text-muted">-</span>';
                const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(path);
                const isPdf = path.toLowerCase().endsWith('.pdf');
                if (isPdf) {
                    return `<a href="${publicUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">View PDF</a>`;
                }
                return `<img src="${publicUrl}" class="img-thumbnail" style="width:70px;height:70px;object-fit:cover;cursor:pointer;" onclick="openPreview('${publicUrl}', 'image')">`;
            }

            window.openPreview = function(url, type = 'image') {
                const frame = document.getElementById('previewFrame');
                const img = document.getElementById('previewImage');
                if (type === 'pdf' || url.toLowerCase().endsWith('.pdf')) {
                    frame.src = url;
                    frame.classList.remove('d-none');
                    img.classList.add('d-none');
                } else {
                    img.src = url;
                    img.classList.remove('d-none');
                    frame.classList.add('d-none');
                    frame.src = '';
                }
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            };

            $('#membersTable').on('click', '.delete-btn', async function() {
                if (!confirm('Permanently delete this member? This cannot be undone.')) return;
                const id = this.dataset.id;
                const { error } = await supabaseAdmin.from('members').delete().eq('id', id);
                if (error) {
                    alert('Delete failed: ' + error.message);
                } else {
                    table.row($(this).parents('tr')).remove().draw();
                    document.getElementById('totalMembers').textContent = parseInt(document.getElementById('totalMembers').textContent) - 1;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadMembers();
        });
    </script>
</body>
</html>