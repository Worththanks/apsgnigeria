<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APSG Event Check-In Scanner</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module" src="supabase-client.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Cormorant+Garamond&family=Roboto&display=swap" rel="stylesheet">

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(to bottom, #f8f9fa, #e9f7ef);
  font-family: 'Roboto', sans-serif;
}

.header {
  text-align: center;
  margin-bottom: 25px;
}

.header img {
  max-width: 120px;
}

.header h1 {
  font-family: 'Playfair Display', serif;
  color: #006400;
  margin-top: 10px;
}

.header p {
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
  font-size: 1.2rem;
}

#reader {
  max-width: 600px;
  margin: 0 auto;
  border: 3px solid #006400;
  border-radius: 15px;
  overflow: hidden;
}

.result {
  max-width: 600px;
  margin: 25px auto;
  padding: 25px;
  text-align: center;
  border-radius: 12px;
  border: 4px double #d4af37;
  background: linear-gradient(135deg, #f9f7f3, #e8e3d8);
  box-shadow: 0 25px 60px rgba(212,175,55,0.35);
}

.result i {
  font-size: 4.5rem;
  margin-bottom: 15px;
}

.success i { color: #d4af37; }
.error i { color: #dc3545; }

.vip-highlight {
  animation: vipGlow 1.8s ease-in-out infinite;
}

@keyframes vipGlow {
  0% { box-shadow: 0 0 10px rgba(212,175,55,.4); }
  50% { box-shadow: 0 0 40px rgba(212,175,55,.9); }
  100% { box-shadow: 0 0 10px rgba(212,175,55,.4); }
}

.guest-info {
  font-family: 'Playfair Display', serif;
  font-size: 1.6rem;
  color: #006400;
}

.welcome-msg {
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
}

footer {
  background: #006400;
  color: white;
  text-align: center;
  padding: 12px;
  margin-top: 50px;
}
</style>
</head>

<body>

<audio id="vipSound" src="assets/sounds/vip-chime.mp3" preload="auto"></audio>

<div class="container my-5">

<div class="header">
  <img src="assets/images/apsg.png" alt="APSG Logo">
  <h1>APC Progressive Support Group</h1>
  <p>2027 and Beyond</p>
</div>

<p class="text-center fs-5 mb-3">
  Scan guest QR code to validate entry
</p>

<div id="reader"></div>

<div id="result" class="result d-none">
  <i id="resultIcon"></i>
  <h3 id="resultTitle"></h3>
  <p id="guestInfo" class="guest-info"></p>
  <p id="welcomeMsg" class="welcome-msg"></p>
</div>

</div>

<footer>
APSG Event Check-In System © 2026
</footer>

<script type="module">
import supabase from './supabase-client.js';

const validGuests = {
  "APSG-2026-000001": {
    name: "Ìyáàfin Oluwafunmilayo Adejoke Ogunba-Koleowo",
    title: "Director-General",
    role: "Host",
    category: "VIP"
  },
  "APSG-2026-000002": {
    name: "Otunba Yeye Irmgard Modupe Okenla",
    title: "Grand Matron",
    role: "Guest of Honour",
    category: "VIP"
  }
};

const scanner = new Html5Qrcode("reader");
const vipSound = document.getElementById("vipSound");

function showResult(title, guest, success) {
  const box = document.getElementById("result");
  box.classList.remove("vip-highlight");

  document.getElementById("resultIcon").className =
    success ? "fas fa-check-circle success" : "fas fa-times-circle error";

  document.getElementById("resultTitle").innerText = title;
  document.getElementById("guestInfo").innerText =
    guest ? `${guest.name} — ${guest.title}` : "";

  document.getElementById("welcomeMsg").innerText =
    success ? `Welcome, ${guest.role}.` : "";

  if (guest && guest.category === "VIP" && success) {
    vipSound.play();
    box.classList.add("vip-highlight");
  }

  box.classList.remove("d-none");
}

scanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 300 },
  async text => {
    const guestId = text.trim();

    if (!validGuests[guestId]) {
      showResult("Invalid QR Code", null, false);
      return;
    }

    const { data: existing } = await supabase
      .from("checkins")
      .select("guest_id")
      .eq("guest_id", guestId)
      .single();

    if (existing) {
      showResult("Already Checked In", validGuests[guestId], false);
      return;
    }

    await supabase.from("checkins").insert([{
      guest_id: guestId,
      name: validGuests[guestId].name,
      category: validGuests[guestId].category
    }]);

    showResult("Access Granted", validGuests[guestId], true);

    scanner.stop().then(() => {
      setTimeout(() => {
        document.getElementById("result").classList.add("d-none");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 300 }, arguments.callee);
      }, 3000);
    });
  }
).catch(() => alert("Camera permission required."));
</script>

</body>
</html>
