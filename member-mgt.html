<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Members – APSG Admin</title>
  
    <!-- Favicon (added multiple sizes for better mobile/browser support without affecting colors) -->
  <link rel="icon" href="/assets/images/apsg.png" sizes="any" />
  <link rel="apple-touch-icon" href="/assets/images/apsg.png" />
  
  <!-- Prevent flash of wrong theme -->
  <script>
    if (localStorage.getItem("daynight-theme") === "carbon") {
      document.documentElement.classList.add("carbon");
    }
  </script>
  <link rel="icon" href="/assets/images/apsg.png" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  
  <!-- DataTables Core -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.css">
  
  <!-- DataTables Responsive Extension (for full mobile responsiveness) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.min.css">
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <style>
    /* Enhanced Premium Members Page */
    body {
      background: linear-gradient(to bottom, #f8fbff, #eef4ff);
    }

    .premium-header {
      background: linear-gradient(135deg, #0033A0 0%, #006400 60%, #640f00 100%);
      color: white;
      padding: 5rem 2rem 4rem;
      text-align: center;
      border-radius: 0 0 3rem 3rem;
      box-shadow: 0 20px 50px rgba(0,51,160,0.3);
      position: relative;
      overflow: hidden;
    }
    .premium-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(255,255,255,0.15), transparent 70%);
    }
    .premium-header .logo-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 6px solid white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      margin-bottom: 1.5rem;
    }
    .premium-header h1 {
      font-size: 3.8rem;
      font-weight: 900;
      margin: 0;
      text-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    .premium-header p {
      font-size: 1.6rem;
      opacity: 0.95;
      margin-top: 1rem;
      font-weight: 500;
    }

    /* Premium Table Card */
    .members-card {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px);
      border-radius: 2rem;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 20px 50px rgba(0,51,160,0.2);
      overflow: hidden;
      margin: 3rem 0;
    }
    .members-card-header {
      background: linear-gradient(to right, #0033A0, #006400);
      color: white;
      padding: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .members-card-header h2 {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 0;
    }
    .total-count {
      font-size: 1.8rem;
      font-weight: 600;
    }

    /* Enhanced DataTable */
    .dataTables_wrapper .dataTables_filter input {
      border-radius: 1rem;
      border: 1px solid #0033A0;
      padding: 0.5rem 1rem;
    }
    table.dataTable thead th {
      background: #0033A0;
      color: white;
      font-weight: 600;
    }
    table.dataTable tbody tr:hover {
      background: rgba(0,51,160,0.1) !important;
    }
    .img-thumbnail {
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .img-thumbnail:hover {
      transform: scale(4);
      z-index: 1000;
      position: relative;
    }

    /* Buttons */
    .dt-buttons .btn {
      background: #006400;
      color: white;
      border: none;
      border-radius: 1rem;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .dt-buttons .btn:hover {
      background: #004d00;
    }
    .btn-danger {
      background: #BF0000;
      border: none;
      border-radius: 0.8rem;
    }

    /* Loading Spinner */
    #tableLoading {
      text-align: center;
      padding: 4rem;
    }
    .spinner {
      border: 6px solid rgba(0,100,0,0.1);
      border-left-color: #006400;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive Adjustments */
    @media (max-width: 992px) {
      .members-card-header { flex-direction: column; text-align: center; }
      .dataTables_wrapper .dataTables_filter { float: none; text-align: center; margin-top: 1rem; }
    }
  </style>
</head>
<body>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" aria-hidden="true"></div>

  <!-- Mobile Menu -->
  <aside class="mobile-menu" aria-label="Mobile navigation">
    <div class="mobile-menu-header">
      <a href="dashboard.html" class="logo">
        <img src="/assets/images/apsg.png" alt="APSG Logo" class="logo-img" />
        <span>APSG Admin</span>
      </a>
      <button class="mobile-menu-close" aria-label="Close menu" onclick="closeMobileMenu()">✕</button>
    </div>
    <nav class="mobile-menu-nav">
      <a href="dashboard.html">Dashboard</a>
      <a href="members.html" class="active">Members</a>
    </nav>
    <div class="mobile-menu-footer">
      <button class="mobile-logout-btn" type="button">Logout</button>
    </div>
  </aside>

  <div class="app-container">
    <!-- Premium Header -->
    <header class="premium-header">
      <img src="/assets/images/apsg.png" alt="APSG Logo" class="logo-img" />
      <h1>Members Management</h1>
      <p>All Progressives Congress Progressive Support Group • Complete Member Directory</p>
    </header>

    <!-- Main Content -->
    <main class="main-content" style="padding: 2rem;">
      <!-- Loading State -->
      <div id="tableLoading">
        <div class="spinner"></div>
        <p class="text-muted fs-4">Loading members from database...</p>
      </div>

      <!-- Members Card -->
      <div class="members-card" id="membersCard" style="display:none;">
        <div class="members-card-header">
          <h2>Registered Members</h2>
          <div class="total-count">Total: <strong id="totalMembers">0</strong></div>
          <div class="dt-buttons"></div>
        </div>
        <div class="table-responsive">
          <table id="membersTable" class="table table-hover" style="width:100%">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>State</th>
                <th>LGA</th>
                <th>Ward</th>
                <th>PVC #</th>
                <th>APC Card #</th>
                <th>PVC Upload</th>
                <th>APC Upload</th>
                <th>Date Registered</th>
                <th>Actions</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

      <!-- No Data -->
      <div id="noDataMessage" class="mt-5" style="display:none;">
        <div class="card text-center py-5">
          <svg viewBox="0 0 24 24" width="160" height="160" fill="none" stroke="#64748B" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4-4v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <h3 class="mt-4 text-muted">No members registered yet</h3>
          <p class="text-muted fs-4">The directory will populate automatically once registrations begin.</p>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer text-center py-5" style="background: #0033A0; color: white;">
      <p class="mb-0 fs-5">© 2026 All Progressives Congress Progressive Support Group (APSG) • Official Admin Portal</p>
    </footer>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Document Preview</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-dark text-center p-4">
          <iframe id="previewFrame" style="width:100%;height:80vh;border:none;border-radius:1rem;"></iframe>
          <img id="previewImage" src="" class="img-fluid d-none" style="max-height:80vh;border-radius:1rem;">
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery & DataTables -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
  
  <!-- DataTables Responsive Extension -->
  <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.min.js"></script>

  <!-- Supabase Shared -->
  <script src="/assets/js/supabase-clients.js"></script>

  <!-- Members Page Script (Enhanced Responsiveness & Total Management) -->
  <script>
    async function loadMembers() {
      document.getElementById('tableLoading').style.display = 'block';
      document.getElementById('membersCard').style.display = 'none';
      document.getElementById('noDataMessage').style.display = 'none';

      const { data: members, error } = await supabaseClient
        .from('members')
        .select('*')
        .order('created_at', { ascending: false });

      document.getElementById('tableLoading').style.display = 'none';

      if (error) {
        console.error('Error:', error);
        alert('Failed to load members: ' + error.message);
        return;
      }

      const total = members.length;
      document.getElementById('totalMembers').textContent = total.toLocaleString();

      if (total === 0) {
        document.getElementById('noDataMessage').style.display = 'block';
        return;
      }

      document.getElementById('membersCard').style.display = 'block';

      const table = $('#membersTable').DataTable({
        data: members,
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'csv',
            text: 'Export CSV',
            className: 'btn btn-success',
            title: 'APSG_Members_' + new Date().toISOString().slice(0,10)
          }
        ],
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100, total],
        responsive: true, // Full responsive - columns collapse on mobile
        columnDefs: [
          { responsivePriority: 1, targets: 0 }, // Name highest priority
          { responsivePriority: 2, targets: 1 }, // Phone
          { responsivePriority: 10000, targets: [3,4] } // LGA/Ward lowest - hide first on small screens
        ],
        language: {
          search: "Search members:",
          lengthMenu: "Show _MENU_ members",
          info: "Showing _START_ to _END_ of _TOTAL_ members",
          emptyTable: "No members found"
        }
      });

      function renderFile(path) {
        if (!path) return '<span class="text-muted">No file</span>';
        const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(path);
        const isPdf = path.toLowerCase().endsWith('.pdf');
        if (isPdf) {
          return `<a href="${publicUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">View PDF</a>`;
        }
        return `<img src="${publicUrl}" class="img-thumbnail" style="cursor:pointer;" data-url="${publicUrl}" data-type="image">`;
      }

      // Re-render file columns (DataTables needs this after init)
      table.column(7).data().each((path, i) => table.cell(i, 7).data(renderFile(path)));
      table.column(8).data().each((path, i) => table.cell(i, 8).data(renderFile(path)));

      // Preview click
      $('#membersTable tbody').on('click', '[data-url]', function() {
        const url = this.dataset.url;
        const type = this.dataset.type || (url.toLowerCase().endsWith('.pdf') ? 'pdf' : 'image');
        const frame = document.getElementById('previewFrame');
        const img = document.getElementById('previewImage');
        if (type === 'pdf') {
          frame.src = url;
          frame.classList.remove('d-none');
          img.classList.add('d-none');
        } else {
          img.src = url;
          img.classList.remove('d-none');
          frame.classList.add('d-none');
          frame.src = '';
        }
        new bootstrap.Modal(document.getElementById('previewModal')).show();
      });

      // Delete with confirmation & update total
      $('#membersTable tbody').on('click', '.delete-btn', async function() {
        if (!confirm('Permanently delete this member?\nThis action cannot be undone.')) return;
        const id = this.dataset.id;
        const { error } = await supabaseAdmin.from('members').delete().eq('id', id);
        if (error) {
          alert('Delete failed: ' + error.message);
        } else {
          table.row($(this).parents('tr')).remove().draw();
          const newTotal = parseInt(document.getElementById('totalMembers').textContent.replace(/,/g, '')) - 1;
          document.getElementById('totalMembers').textContent = newTotal.toLocaleString();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      loadMembers();
    });
  </script>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Theme Script -->
  <script src="/assets/js/styles.js"></script>
</body>
</html>