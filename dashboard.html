<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APSG Admin Dashboard</title>
    <link rel="icon" href="/assets/images/apsg.png" sizes="any">
    <link rel="apple-touch-icon" href="/assets/images/apsg.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#79ecd9',
                        'primary-light': '#eef2ff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        if (localStorage.getItem("daynight-theme") === "carbon") {
            document.documentElement.classList.add("dark");
        }
    </script>
    <style>
        /* Sidebar links */
        :root {
          --primary: #1db609;
          --primary-light: #dbeafe;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;              /* gap-2 */
            padding: 0.5rem 0.75rem;  /* px-3 py-2 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem;     /* text-sm */
            transition: all 0.2s ease;
        }

        .sidebar-link:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .sidebar-link.active {
            background-color: var(--primary);
            color: #ffffff;
        }

        /* Cards */
        .card {
            background-color: #ffffff;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem;      /* p-3 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dark .card {
            background-color: #1f2937; /* gray-800 */
        }

        .card:hover {
            box-shadow: 0 10px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        /* Stat icon */
        .stat-icon {
            width: 2.5rem;   /* w-10 */
            height: 2.5rem;  /* h-10 */
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; /* text-lg */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Chart container */
        .chart-container {
            height: 10rem; /* h-40 */
        }

        /* Mobile overlay */
        #mobile-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
            transition: opacity 0.3s ease;
        }

        /* Hide overlay on md and above */
        @media (min-width: 768px) {
            #mobile-overlay {
                display: none;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col text-sm">
    <div id="mobile-overlay" class="hidden" onclick="closeSidebar()"></div>
    <div class="flex flex-1">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-56 bg-white dark:bg-gray-800 shadow-md transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <a href="dashboard.html" class="flex items-center gap-2">
                    <img src="/assets/images/apsg.png" alt="APSG Logo" class="h-8 w-auto">
                    <span class="text-lg font-semibold">APSG Admin</span>
                </a>
            </div>
            <nav class="p-2 space-y-1">
                <a href="dashboard.html" class="sidebar-link active">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    Dashboard
                </a>
                <a href="members.html" class="sidebar-link">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4-4v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Members
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-2 border-t border-gray-200 dark:border-gray-700">
                <button onclick="logout()" class="w-full sidebar-link text-left text-red-600 dark:text-red-400">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>
        <div class="flex-1 flex flex-col md:ml-56">
            <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
                <div class="flex items-center justify-between px-3 py-2">
                    <div class="flex items-center gap-2">
                        <button id="mobile-toggle" onclick="toggleSidebar()" class="md:hidden text-lg">
                            <i class="fas fa-bars"></i>
                        </button>
                        <a href="dashboard.html" class="md:hidden flex items-center gap-1">
                            <img src="/assets/images/apsg.png" alt="APSG" class="h-6">
                            <span class="font-medium">APSG</span>
                        </a>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-md p-0.5">
                            <button onclick="setTheme('snow')" class="theme-btn-snow px-2 py-0.5 rounded transition-all">
                                <i class="fas fa-sun text-sm"></i>
                            </button>
                            <button onclick="setTheme('carbon')" class="theme-btn-carbon px-2 py-0.5 rounded transition-all">
                                <i class="fas fa-moon text-sm"></i>
                            </button>
                        </div>
                        <button onclick="logout()" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </header>
            <main class="flex-1 p-3 overflow-auto">
                <div class="mb-4">
                    <h1 class="text-2xl font-semibold">APSG Dashboard</h1>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Overview of APC Progressive Support Group (APSG) With PVC and APC Membership Card</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                    <div class="card flex items-start gap-2">
                        <div class="stat-icon bg-primary-light text-primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Total Members</p>
                            <p class="text-xl font-semibold mt-0.5" id="totalMembers">0</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-2">
                        <div class="stat-icon bg-green-100 dark:bg-green-900/20 text-success">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Today's Registrations</p>
                            <p class="text-xl font-semibold mt-0.5" id="todaysRegistrations">0</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-2">
                        <div class="stat-icon bg-primary-light text-primary">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Top Three States</p>
                            <p class="text-xs font-medium mt-0.5" id="topStatesValue">Loading...</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-2">
                        <div class="stat-icon bg-warning/20 text-warning">
                            <i class="fas fa-city"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Top Three LGAs</p>
                            <p class="text-xs font-medium mt-0.5" id="topLgasValue">Loading...</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-2">
                        <div class="stat-icon bg-red-100 dark:bg-red-900/20 text-danger">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Active States</p>
                            <p class="text-xl font-semibold mt-0.5" id="activeStates">0</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <div class="card">
                        <h3 class="text-base font-medium mb-1">Registrations by State</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Top states (others grouped)</p>
                        <div class="chart-container flex justify-center relative">
                            <svg viewBox="0 0 36 36" class="w-40 h-40">
                                <circle cx="18" cy="18" r="15.9" fill="none" stroke="#e5e7eb" stroke-width="3" stroke-dasharray="100 100"/>
                                <circle class="donut-segment" cx="18" cy="18" r="15.9" fill="none" stroke="#79ecd9" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                <circle class="donut-segment" cx="18" cy="18" r="15.9" fill="none" stroke="#10b981" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                <circle class="donut-segment" cx="18" cy="18" r="15.9" fill="none" stroke="#f59e0b" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                <circle class="donut-segment" cx="18" cy="18" r="15.9" fill="none" stroke="#ef4444" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                <circle class="donut-segment" cx="18" cy="18" r="15.9" fill="none" stroke="#a855f7" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                <text x="18" y="18" text-anchor="middle" dy=".3em" class="text-lg font-semibold fill-gray-900 dark:fill-gray-100" id="donut-value">0</text>
                            </svg>
                            
                            <div id="donut-legend" class="absolute right-0 top-0 text-xs space-y-1"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-base font-medium mb-1">Recent Registrations</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Last 7 days</p>
                        <div class="chart-container flex items-end justify-between gap-1">
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">6d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">5d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">4d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">3d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">2d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">1d</span>
                            </div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="bar w-full bg-primary rounded-t" style="height:0px;transition:height 0.6s ease;"></div>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">Today</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="noDataMessage" class="hidden text-center mt-6 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <i class="fas fa-inbox text-2xl text-gray-400 mb-1"></i>
                    <p class="text-base">No registrations yet. Data will appear here once members start registering.</p>
                </div>
            </main>
            <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-2 text-center text-xs text-gray-600 dark:text-gray-400">
                © 2026 APC Progressive Support Group (APSG Nigeria) Admin Dashboard. All rights reserved.
            </footer>
        </div>
    </div>
    <script src="/assets/js/supabase-clients.js"></script>
    <script type="module">
         const els = {
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('mobile-overlay'),
            totalMembers: document.getElementById('totalMembers'),
            todaysRegistrations: document.getElementById('todaysRegistrations'),
            activeStates: document.getElementById('activeStates'),
            topStatesValue: document.getElementById('topStatesValue'),
            topLgasValue: document.getElementById('topLgasValue'),
            donutValue: document.getElementById('donut-value'),
            donutSegments: document.querySelectorAll('.donut-segment'),
            donutLegend: document.getElementById('donut-legend'),
            lgaDonutValue: document.getElementById('lga-donut-value'),
            lgaDonutSegments: document.querySelectorAll('.lga-donut-segment'),
            lgaDonutLegend: document.getElementById('lga-donut-legend'),
            genderDonutValue: document.getElementById('gender-donut-value'),
            genderDonutSegments: document.querySelectorAll('.gender-donut-segment'),
            genderDonutLegend: document.getElementById('gender-donut-legend'),
            bars: document.querySelectorAll('.bar'),
            noDataMessage: document.getElementById('noDataMessage')
        };

        // === UI Module ===
        const ui = {
            toggleSidebar() {
                els.sidebar.classList.toggle('-translate-x-full');
                els.overlay.classList.toggle('hidden');
            },
            closeSidebar() {
                els.sidebar.classList.add('-translate-x-full');
                els.overlay.classList.add('hidden');
            },
            setTheme(mode) {
                if (mode === 'carbon') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('daynight-theme', 'carbon');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('daynight-theme', 'snow');
                }
                // Update active button highlight
                document.querySelectorAll('.theme-btn-snow, .theme-btn-carbon').forEach(btn => {
                    btn.classList.toggle('bg-gray-300', btn.classList.contains(`theme-btn-${mode}`));
                    btn.classList.toggle('dark:bg-gray-600', btn.classList.contains(`theme-btn-${mode}`));
                });
            }
        };

        // === Auth Module ===
        const auth = {
            async logout() {
                if (typeof supabaseClient !== 'undefined') {
                    await supabaseClient.auth.signOut();
                }
                window.location.href = 'login.html';
            }
        };

        // === Data Module ===
        const data = {
            async loadDashboard() {
                try {
                    const { data: members, error } = await supabaseClient
                        .from('members')
                        .select('*');

                    if (error) throw error;
                    if (!members || members.length === 0) {
                        els.noDataMessage.classList.remove('hidden');
                        return;
                    }

                    const total = members.length;
                    const today = new Date().toISOString().slice(0, 10);
                    const todaysCount = members.filter(m => m.created_at?.slice(0, 10) === today).length;

                    els.totalMembers.textContent = total.toLocaleString();
                    els.todaysRegistrations.textContent = todaysCount;

                    // Active States
                    const uniqueStates = new Set(members.map(m => m.state?.trim()).filter(Boolean));
                    els.activeStates.textContent = uniqueStates.size;

                    // State Counts for Donut and Top States
                    const stateCounts = {};
                    members.forEach(m => {
                        const state = m.state?.trim();
                        if (state) stateCounts[state] = (stateCounts[state] || 0) + 1;
                    });
                    const sortedStates = Object.entries(stateCounts).sort((a, b) => b[1] - a[1]);
                    const topThree = sortedStates.slice(0, 3);
                    const topThreeStr = topThree.map(([state, count], idx) => `${idx + 1}. ${state} (${count})`).join(' • ');
                    els.topStatesValue.textContent = topThreeStr || 'No data';

                     // Top Three LGAs
                    const lgaCounts = {};
                    members.forEach(m => {
                        const lga = m.lga?.trim();
                        if (lga) lgaCounts[lga] = (lgaCounts[lga] || 0) + 1;
                    });
                    const sortedLGAs = Object.entries(lgaCounts).sort((a, b) => b[1] - a[1]);
                    const topThreeLGAs = sortedLGAs.slice(0, 3);
                    const topThreeLGAsStr = topThreeLGAs.map(([l, c], i) => `${i+1}. ${l} (${c})`).join(' • ');
                    els.topLgasValue.textContent = topThreeLGAsStr || 'No data';


                    // Group for Donut: Top 4 + Others
                    const topFour = sortedStates.slice(0, 4);
                    const othersCount = total - topFour.reduce((sum, [_, c]) => sum + c, 0);
                    const donutData = [...topFour];
                    if (othersCount > 0) donutData.push(['Others', othersCount]);

                    // Donut Chart
                    const colors = ['#79ecd9', '#10b981', '#f59e0b', '#ef4444', '#94a3b8'];
                    let offset = 0;
                    els.donutSegments.forEach((seg, i) => {
                        if (i < donutData.length) {
                            const [name, count] = donutData[i];
                            const percent = (count / total * 100) || 0;
                            seg.style.strokeDasharray = `${percent} 100`;
                            seg.style.strokeDashoffset = -offset;
                            seg.style.stroke = colors[i % colors.length];
                            offset += percent;



                            
                            // Legend Item
                            const legendItem = document.createElement('div');
                            legendItem.classList.add('flex', 'items-center', 'gap-1');
                            legendItem.innerHTML = `
                                <div class="w-2 h-2 rounded-full" style="background-color: ${colors[i % colors.length]}"></div>
                                <span>${name}: ${count}</span>
                            `;
                            els.donutLegend.appendChild(legendItem);
                        } else {
                            seg.style.strokeDasharray = '0 100';
                        }
                    });
                    els.donutValue.textContent = total;


                    

                    // Recent 7 Days Bar Chart
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().slice(0, 10));
                }
                const counts = last7Days.map(date => 
                    members.filter(m => m.created_at?.slice(0, 10) === date).length
                );
                const bars = document.querySelectorAll('.bar');
                bars.forEach((bar, i) => {
                    const count = counts[i] || 0;
                    bar.style.height = Math.max(8, count * 12) + 'px';
                });

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('noDataMessage').innerHTML = '<p class="text-red-600">Error loading data. Please check console.</p>';
                document.getElementById('noDataMessage').classList.remove('hidden');
            }
        }
        };

        // === Init ===
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof checkAuth === 'function') await checkAuth();
            await data.loadDashboard();

            // Initial theme button highlight
            const isDark = document.documentElement.classList.contains('dark');
            ui.setTheme(isDark ? 'carbon' : 'snow');
        });

        // Expose to global for onclick
        window.toggleSidebar = ui.toggleSidebar;
        window.closeSidebar = ui.closeSidebar;
        window.setTheme = ui.setTheme;
        window.logout = auth.logout;
    </script>
</body>
</html>