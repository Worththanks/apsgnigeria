<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Details - APSG Admin</title>
    <link rel="icon" href="/assets/images/apsg.png" sizes="any">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: radial-gradient(circle at top left, #f0fdf4, #ecfdf5), radial-gradient(circle at bottom right, #ecfdf5, #f0fdfa);
            min-height: 100vh;
        }
        .lux-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(240,253,244,0.88));
            backdrop-filter: blur(8px);
            border: 1px solid rgba(34,197,94,0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .reg-number {
            font-family: ui-monospace, monospace;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            padding: 0.35rem 0.7rem;
            border-radius: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            box-shadow: 0 2px 8px rgba(34,197,94,0.1);
        }
        .upload-thumb {
            width: 100%;
            max-width: 20rem;
            height: 14rem;
            object-fit: cover;
            border-radius: 0.75rem;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .upload-thumb:hover {
            transform: scale(1.05) translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
        }
        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 0.875rem;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.15);
        }
        .upload-area {
            border: 2px dashed rgba(34,197,94,0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #22c55e;
        }
        /* Preview Modal */
        #previewModal .modal-dialog {
            max-width: 96vw;
            margin: 0.5rem auto;
        }
        #previewModal .modal-body {
            padding: 0;
            height: calc(100vh - 140px);
            background: #f8fafc;
            position: relative;
        }
        #previewFrame, #previewImage {
            width: 100%;
            height: 100%;
            border: none;
        }
        #previewImage {
            object-fit: contain;
            transition: transform 0.1s;
        }
        .zoom-controls {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.375rem;
            background: rgba(255,255,255,0.8);
            padding: 0.375rem;
            border-radius: 9999px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .zoom-btn {
            background-color: #fff;
            color: #374151;
            padding: 0.375rem;
            border-radius: 9999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .zoom-btn:hover {
            background-color: #f3f4f6;
        }
        /* Sidebar */
        :root {
            --primary: #1db609;
            --primary-light: #dbeafe;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        .sidebar-link.active {
            background-color: var(--primary);
            color: #ffffff;
        }
        #mobile-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
            transition: opacity 0.3s ease;
        }
        @media (min-width: 768px) {
            #mobile-overlay { display: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-sm">
    <div id="mobile-overlay" class="hidden" onclick="closeSidebar()"></div>
    <div class="flex flex-1">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-56 bg-white shadow-md transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto lux-card">
            <div class="p-3 border-b border-gray-200">
                <a href="dashboard.html" class="flex items-center gap-2">
                    <img src="/assets/images/apsg.png" alt="APSG Logo" class="h-8 w-auto">
                    <span class="text-lg font-semibold">APSG Admin</span>
                </a>
            </div>
            <nav class="p-2 space-y-1">
                <a href="dashboard.html" class="sidebar-link">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    Dashboard
                </a>
                <a href="members.html" class="sidebar-link active">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4-4v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Members
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-2 border-t border-gray-200">
                <button onclick="logout()" class="w-full sidebar-link text-left text-red-600">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>
        <div class="flex-1 flex flex-col md:ml-56">
            <header class="bg-white shadow-sm sticky top-0 z-40 lux-card">
                <div class="flex items-center justify-between px-3 py-2">
                    <div class="flex items-center gap-2">
                        <button id="mobile-toggle" onclick="toggleSidebar()" class="md:hidden text-lg">
                            <i class="fas fa-bars"></i>
                        </button>
                        <a href="dashboard.html" class="md:hidden flex items-center gap-1">
                            <img src="/assets/images/apsg.png" alt="APSG" class="h-6">
                            <span class="font-medium">APSG</span>
                        </a>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="logout()" class="p-1 rounded hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </header>
            <main class="flex-1 p-4 overflow-auto max-w-screen-xl mx-auto w-full">
                <div class="mb-4 flex items-center justify-between">
                    <a href="members.html" class="inline-flex items-center gap-2 text-green-700 hover:text-green-800 font-medium">
                        <i class="fas fa-arrow-left"></i> Back to Members List
                    </a>
                </div>

                <div class="lux-card p-6 mb-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-6">
                        <div>
                            <div class="reg-number text-lg mb-2" id="detailRegNumber">—</div>
                            <h1 class="text-3xl font-bold text-green-900" id="detailFullName">Loading...</h1>
                            <p class="text-gray-600 mt-1" id="detailDesignation">—</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Personal Information -->
                    <div class="lux-card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-800">Personal Information</h3>
                        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <dt class="font-medium text-gray-600">First Name</dt>
                                <dd id="detailFirstName">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">Last Name</dt>
                                <dd id="detailLastName">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">Phone</dt>
                                <dd id="detailPhone">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">Email</dt>
                                <dd id="detailEmail">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">State</dt>
                                <dd id="detailState">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">LGA</dt>
                                <dd id="detailLga">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">Ward</dt>
                                <dd id="detailWard">-</dd>
                            </div>
                            <div>
                                <dt class="font-medium text-gray-600">Registration Date</dt>
                                <dd id="detailDate">-</dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Verification Documents -->
                    <div class="lux-card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-800">Verification Documents</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <!-- PVC Document -->
                            <div class="text-center">
                                <p class="font-medium mb-2">PVC Document</p>
                                <p class="text-xs text-gray-600 mb-3"><strong>Number:</strong> <span id="detailPvc">-</span></p>
                                <img src="/assets/images/pdf-placeholder.png" alt="PVC Preview" class="upload-thumb mx-auto mb-4" id="pvcPreview">
                                <div class="flex justify-center gap-3 mb-4">
                                    <button class="action-btn bg-green-600 text-white hover:bg-green-700" id="pvcViewBtn" disabled>View</button>
                                    <button class="action-btn bg-emerald-600 text-white hover:bg-emerald-700 hidden" id="pvcDownloadBtn">Download</button>
                                </div>
                                <div class="upload-area">
                                    <p class="text-sm font-medium text-gray-700 mb-3">Upload / Replace PVC Document</p>
                                    <input type="file" id="pvcFileInput" accept="image/*,application/pdf" class="hidden">
                                    <button type="button" onclick="document.getElementById('pvcFileInput').click()" class="action-btn bg-indigo-600 text-white hover:bg-indigo-700 mb-2">Select File</button>
                                    <p id="pvcFileName" class="text-xs text-gray-500 mb-3">No file chosen</p>
                                    <button id="pvcUploadBtn" class="action-btn bg-green-600 text-white hover:bg-green-700" disabled>Upload</button>
                                    <p id="pvcStatus" class="mt-3 text-xs font-medium"></p>
                                </div>
                            </div>
                            <!-- APC Card -->
                            <div class="text-center">
                                <p class="font-medium mb-2">APC Card</p>
                                <p class="text-xs text-gray-600 mb-3"><strong>Number:</strong> <span id="detailApc">-</span></p>
                                <img src="/assets/images/pdf-placeholder.png" alt="APC Preview" class="upload-thumb mx-auto mb-4" id="apcPreview">
                                <div class="flex justify-center gap-3 mb-4">
                                    <button class="action-btn bg-green-600 text-white hover:bg-green-700" id="apcViewBtn" disabled>View</button>
                                    <button class="action-btn bg-emerald-600 text-white hover:bg-emerald-700 hidden" id="apcDownloadBtn">Download</button>
                                </div>
                                <div class="upload-area">
                                    <p class="text-sm font-medium text-gray-700 mb-3">Upload / Replace APC Card</p>
                                    <input type="file" id="apcFileInput" accept="image/*,application/pdf" class="hidden">
                                    <button type="button" onclick="document.getElementById('apcFileInput').click()" class="action-btn bg-indigo-600 text-white hover:bg-indigo-700 mb-2">Select File</button>
                                    <p id="apcFileName" class="text-xs text-gray-500 mb-3">No file chosen</p>
                                    <button id="apcUploadBtn" class="action-btn bg-green-600 text-white hover:bg-green-700" disabled>Upload</button>
                                    <p id="apcStatus" class="mt-3 text-xs font-medium"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="hidden text-center mt-8 p-6 lux-card text-red-600">
                    <p class="text-lg">Member not found or error loading data.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content rounded-xl overflow-hidden shadow-2xl">
                <div class="modal-header bg-gradient-to-r from-green-600 to-emerald-700 text-white">
                    <h5 class="modal-title font-bold">Document Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 relative">
                    <iframe id="previewFrame" class="d-none"></iframe>
                    <img id="previewImage" class="d-none">
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-search-plus"></i></button>
                        <button class="zoom-btn" onclick="zoomOut()"><i class="fas fa-search-minus"></i></button>
                        <button class="zoom-btn" onclick="resetZoom()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/supabase-clients.js"></script>
    <script>
        let zoomLevel = 1;
        let currentMember = null;

        const els = {
            detailRegNumber: document.getElementById('detailRegNumber'),
            detailFullName: document.getElementById('detailFullName'),
            detailDesignation: document.getElementById('detailDesignation'),
            detailFirstName: document.getElementById('detailFirstName'),
            detailLastName: document.getElementById('detailLastName'),
            detailPhone: document.getElementById('detailPhone'),
            detailEmail: document.getElementById('detailEmail'),
            detailState: document.getElementById('detailState'),
            detailLga: document.getElementById('detailLga'),
            detailWard: document.getElementById('detailWard'),
            detailDate: document.getElementById('detailDate'),
            detailPvc: document.getElementById('detailPvc'),
            detailApc: document.getElementById('detailApc'),
            pvcPreview: document.getElementById('pvcPreview'),
            pvcViewBtn: document.getElementById('pvcViewBtn'),
            pvcDownloadBtn: document.getElementById('pvcDownloadBtn'),
            apcPreview: document.getElementById('apcPreview'),
            apcViewBtn: document.getElementById('apcViewBtn'),
            apcDownloadBtn: document.getElementById('apcDownloadBtn'),
            errorMessage: document.getElementById('errorMessage')
        };

        async function loadMember() {
            try {
                const params = new URLSearchParams(location.search);
                const id = params.get('id');
                if (!id) throw new Error('No member ID');

                const { data: member, error } = await supabaseClient
                    .from('members')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !member) throw new Error('Member not found');

                currentMember = member;

                const fullName = `${member.first_name || ''} ${member.last_name || ''}`.trim() || 'N/A';

                els.detailRegNumber.textContent = member.reg_number || '—';
                els.detailFullName.textContent = fullName;
                els.detailDesignation.textContent = member.designation || 'Member';
                els.detailFirstName.textContent = member.first_name || '—';
                els.detailLastName.textContent = member.last_name || '—';
                els.detailPhone.textContent = member.phone || '—';
                els.detailEmail.textContent = member.email || '—';
                els.detailState.textContent = member.state || '—';
                els.detailLga.textContent = member.lga || '—';
                els.detailWard.textContent = member.ward || '—';
                els.detailDate.textContent = member.created_at
                    ? new Date(member.created_at).toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' })
                    : '—';
                els.detailPvc.textContent = member.pvc_number || '—';
                els.detailApc.textContent = member.apc_card_number || '—';

                await setupDocument(member.pvc_upload_path, 'pvc');
                await setupDocument(member.apc_upload_path, 'apc');
            } catch (e) {
                console.error(e);
                els.errorMessage.classList.remove('hidden');
            }
        }

        async function setupDocument(uploadPath, type) {
            const previewEl = document.getElementById(`${type}Preview`);
            const viewBtn = document.getElementById(`${type}ViewBtn`);
            const downloadBtn = document.getElementById(`${type}DownloadBtn`);
            const fileNameEl = document.getElementById(`${type}FileName`);
            const uploadBtn = document.getElementById(`${type}UploadBtn`);
            const statusEl = document.getElementById(`${type}Status`);

            const pdfPlaceholder = '/assets/images/pdf-placeholder.png';
            const noUpload = '/assets/images/no-upload.png';

            fileNameEl.textContent = 'No file chosen';
            uploadBtn.disabled = true;
            statusEl.textContent = '';

            if (!uploadPath) {
                previewEl.src = noUpload;
                viewBtn.disabled = true;
                downloadBtn.classList.add('hidden');
                return;
            }

            // Use public URL (for public bucket) or switch to signed if private
            const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(uploadPath);

            const isPdf = uploadPath.toLowerCase().endsWith('.pdf');
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(uploadPath);

            previewEl.src = isPdf ? pdfPlaceholder : (isImage ? publicUrl : noUpload);
            previewEl.onclick = () => openPreview(publicUrl, isPdf ? 'pdf' : 'image');
            viewBtn.onclick = () => openPreview(publicUrl, isPdf ? 'pdf' : 'image');
            viewBtn.disabled = false;
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = publicUrl;
                a.download = uploadPath.split('/').pop();
                a.click();
            };
            downloadBtn.classList.remove('hidden');
        }

        // Upload handlers
        document.getElementById('pvcFileInput').addEventListener('change', function() { handleFileSelect('pvc', this); });
        document.getElementById('apcFileInput').addEventListener('change', function() { handleFileSelect('apc', this); });

        document.getElementById('pvcUploadBtn').addEventListener('click', () => uploadDocument('pvc'));
        document.getElementById('apcUploadBtn').addEventListener('click', () => uploadDocument('apc'));

        function handleFileSelect(type, input) {
            if (input.files && input.files[0]) {
                document.getElementById(`${type}FileName`).textContent = input.files[0].name;
                document.getElementById(`${type}UploadBtn`).disabled = false;
            }
        }

        async function uploadDocument(type) {
            const input = document.getElementById(`${type}FileInput`);
            const file = input.files[0];
            if (!file || !currentMember) return;

            const statusEl = document.getElementById(`${type}Status`);
            const uploadBtn = document.getElementById(`${type}UploadBtn`);
            statusEl.textContent = 'Uploading...';
            statusEl.className = 'mt-3 text-xs font-medium text-gray-600';
            uploadBtn.disabled = true;

            // Unique filename to avoid conflicts
            const ext = file.name.split('.').pop();
            const filename = `${currentMember.id}_${Date.now()}.${ext}`;
            const path = `${type}/${filename}`;

            const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(path, file, {
                cacheControl: '3600',
                upsert: true
            });

            if (uploadError) {
                statusEl.textContent = `Upload failed: ${uploadError.message}`;
                statusEl.className = 'mt-3 text-xs font-medium text-red-600';
                uploadBtn.disabled = false;
                return;
            }

            // Update member record
            const { error: updateError } = await supabaseClient
                .from('members')
                .update({ [`${type}_upload_path`]: path })
                .eq('id', currentMember.id);

            if (updateError) {
                statusEl.textContent = `Update failed: ${updateError.message}`;
                statusEl.className = 'mt-3 text-xs font-medium text-red-600';
                uploadBtn.disabled = false;
                return;
            }

            statusEl.textContent = 'Uploaded successfully!';
            statusEl.className = 'mt-3 text-xs font-medium text-green-600';

            // Refresh preview
            await setupDocument(path, type);

            // Reset input
            input.value = '';
            document.getElementById(`${type}FileName`).textContent = 'No file chosen';
            uploadBtn.disabled = true;
        }

        function openPreview(url, type) {
            const frame = document.getElementById('previewFrame');
            const img = document.getElementById('previewImage');
            resetZoom();
            if (type === 'pdf') {
                frame.src = url;
                frame.classList.remove('d-none');
                img.classList.add('d-none');
                document.querySelector('.zoom-controls').style.display = 'none';
            } else {
                img.src = url;
                img.classList.remove('d-none');
                frame.classList.add('d-none');
                document.querySelector('.zoom-controls').style.display = 'flex';
            }
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        window.zoomIn = () => { zoomLevel += 0.2; document.getElementById('previewImage').style.transform = `scale(${zoomLevel})`; };
        window.zoomOut = () => { if (zoomLevel > 0.2) zoomLevel -= 0.2; document.getElementById('previewImage').style.transform = `scale(${zoomLevel})`; };
        window.resetZoom = () => { zoomLevel = 1; document.getElementById('previewImage').style.transform = 'scale(1)'; };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('mobile-overlay').classList.toggle('hidden');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('mobile-overlay').classList.add('hidden');
        }

        async function logout() {
            if (typeof supabaseClient !== 'undefined') await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', loadMember);
        window.toggleSidebar = toggleSidebar;
        window.closeSidebar = closeSidebar;
        window.logout = logout;
    </script>
</body>
</html>