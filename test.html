<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Form</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        form { display: grid; gap: 10px; }
        label { font-weight: bold; }
        input, select { padding: 8px; width: 100%; box-sizing: border-box; }
        button { padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>Registration Form</h1>
    <form id="regForm">
        <label for="first_name">First Name:</label>
        <input type="text" id="first_name" name="first_name" required>

        <label for="last_name">Last Name:</label>
        <input type="text" id="last_name" name="last_name" required>

        <label for="designation">Designation:</label>
        <input type="text" id="designation" name="designation" required>

        <label for="phone">Phone:</label>
        <input type="tel" id="phone" name="phone" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="state">State:</label>
        <select id="state" name="state" required>
            <option value="">Select State</option>
            <option value="Abia">Abia</option>
            <option value="Adamawa">Adamawa</option>
            <option value="Akwa Ibom">Akwa Ibom</option>
            <option value="Anambra">Anambra</option>
            <option value="Bauchi">Bauchi</option>
            <option value="Bayelsa">Bayelsa</option>
            <option value="Benue">Benue</option>
            <option value="Borno">Borno</option>
            <option value="Cross River">Cross River</option>
            <option value="Delta">Delta</option>
            <option value="Ebonyi">Ebonyi</option>
            <option value="Edo">Edo</option>
            <option value="Ekiti">Ekiti</option>
            <option value="Enugu">Enugu</option>
            <option value="Federal Capital Territory">Federal Capital Territory</option>
            <option value="Gombe">Gombe</option>
            <option value="Imo">Imo</option>
            <option value="Jigawa">Jigawa</option>
            <option value="Kaduna">Kaduna</option>
            <option value="Kano">Kano</option>
            <option value="Katsina">Katsina</option>
            <option value="Kebbi">Kebbi</option>
            <option value="Kogi">Kogi</option>
            <option value="Kwara">Kwara</option>
            <option value="Lagos">Lagos</option>
            <option value="Nasarawa">Nasarawa</option>
            <option value="Niger">Niger</option>
            <option value="Ogun">Ogun</option>
            <option value="Ondo">Ondo</option>
            <option value="Osun">Osun</option>
            <option value="Oyo">Oyo</option>
            <option value="Plateau">Plateau</option>
            <option value="Rivers">Rivers</option>
            <option value="Sokoto">Sokoto</option>
            <option value="Taraba">Taraba</option>
            <option value="Yobe">Yobe</option>
            <option value="Zamfara">Zamfara</option>
        </select>

        <label for="lga">LGA:</label>
        <select id="lga" name="lga" required>
            <option value="">Select LGA</option>
        </select>

        <label for="ward">Ward:</label>
        <select id="ward" name="ward" required>
            <option value="">Select Ward</option>
        </select>

        <label for="polling_unit">Polling Unit:</label>
        <select id="polling_unit" name="polling_unit" required>
            <option value="">Select Polling Unit</option>
        </select>

        <label for="pvc_number">PVC Number:</label>
        <input type="text" id="pvc_number" name="pvc_number" required>

        <label for="apc_card_number">APC Card Number:</label>
        <input type="text" id="apc_card_number" name="apc_card_number" required>

        <label for="pvc_upload">PVC Upload:</label>
        <input type="file" id="pvc_upload" name="pvc_upload" accept="image/*" required>

        <label for="apc_upload">APC Card Upload:</label>
        <input type="file" id="apc_upload" name="apc_upload" accept="image/*" required>

        <button type="submit">Submit</button>
    </form>

    <script src="supabase-clients.js"></script>
    <script>
        let geoData = [];

        fetch('https://raw.githubusercontent.com/afeibukun/nigerian-state-lgas-wards-polling-units/main/states-and-lgas-and-wards-and-polling-units.json')
            .then(response => response.json())
            .then(data => {
                geoData = data;
            })
            .catch(error => console.error('Error loading geo data:', error));

        const stateSelect = document.getElementById('state');
        const lgaSelect = document.getElementById('lga');
        const wardSelect = document.getElementById('ward');
        const puSelect = document.getElementById('polling_unit');

        stateSelect.addEventListener('change', () => {
            const selectedState = stateSelect.value.toLowerCase().replace('federal capital territory', 'fct');
            lgaSelect.innerHTML = '<option value="">Select LGA</option>';
            wardSelect.innerHTML = '<option value="">Select Ward</option>';
            puSelect.innerHTML = '<option value="">Select Polling Unit</option>';
            const stateObj = geoData.find(s => s.state.toLowerCase() === selectedState || (selectedState === 'fct' && s.state.toLowerCase().includes('abuja')));
            if (stateObj) {
                stateObj.lgas.sort((a, b) => a.lga.localeCompare(b.lga)).forEach(lgaObj => {
                    const option = document.createElement('option');
                    option.value = lgaObj.lga;
                    option.textContent = lgaObj.lga.toUpperCase().replace(/-/g, ' ');
                    lgaSelect.appendChild(option);
                });
            }
        });

        lgaSelect.addEventListener('change', () => {
            const selectedState = stateSelect.value.toLowerCase().replace('federal capital territory', 'fct');
            const selectedLga = lgaSelect.value;
            wardSelect.innerHTML = '<option value="">Select Ward</option>';
            puSelect.innerHTML = '<option value="">Select Polling Unit</option>';
            const stateObj = geoData.find(s => s.state.toLowerCase() === selectedState || (selectedState === 'fct' && s.state.toLowerCase().includes('abuja')));
            if (stateObj) {
                const lgaObj = stateObj.lgas.find(l => l.lga === selectedLga);
                if (lgaObj) {
                    lgaObj.wards.sort((a, b) => a.ward.localeCompare(b.ward)).forEach(wardObj => {
                        const option = document.createElement('option');
                        option.value = wardObj.ward;
                        option.textContent = wardObj.ward.toUpperCase().replace(/-/g, ' ');
                        wardSelect.appendChild(option);
                    });
                }
            }
        });

        wardSelect.addEventListener('change', () => {
            const selectedState = stateSelect.value.toLowerCase().replace('federal capital territory', 'fct');
            const selectedLga = lgaSelect.value;
            const selectedWard = wardSelect.value;
            puSelect.innerHTML = '<option value="">Select Polling Unit</option>';
            const stateObj = geoData.find(s => s.state.toLowerCase() === selectedState || (selectedState === 'fct' && s.state.toLowerCase().includes('abuja')));
            if (stateObj) {
                const lgaObj = stateObj.lgas.find(l => l.lga === selectedLga);
                if (lgaObj) {
                    const wardObj = lgaObj.wards.find(w => w.ward === selectedWard);
                    if (wardObj) {
                        wardObj.polling_units.sort().forEach(pu => {
                            const option = document.createElement('option');
                            option.value = pu;
                            option.textContent = pu.toUpperCase().replace(/-/g, ' ');
                            puSelect.appendChild(option);
                        });
                    }
                }
            }
        });

        const stateCodes = {
            'Abia': 'AB',
            'Adamawa': 'AD',
            'Akwa Ibom': 'AK',
            'Anambra': 'AN',
            'Bauchi': 'BA',
            'Bayelsa': 'BY',
            'Benue': 'BE',
            'Borno': 'BO',
            'Cross River': 'CR',
            'Delta': 'DE',
            'Ebonyi': 'EB',
            'Edo': 'ED',
            'Ekiti': 'EK',
            'Enugu': 'EN',
            'Federal Capital Territory': 'FC',
            'Gombe': 'GO',
            'Imo': 'IM',
            'Jigawa': 'JI',
            'Kaduna': 'KD',
            'Kano': 'KN',
            'Katsina': 'KT',
            'Kebbi': 'KE',
            'Kogi': 'KO',
            'Kwara': 'KW',
            'Lagos': 'LA',
            'Nasarawa': 'NA',
            'Niger': 'NI',
            'Ogun': 'OG',
            'Ondo': 'ON',
            'Osun': 'OS',
            'Oyo': 'OY',
            'Plateau': 'PL',
            'Rivers': 'RI',
            'Sokoto': 'SO',
            'Taraba': 'TA',
            'Yobe': 'YO',
            'Zamfara': 'ZA'
        };

        const form = document.getElementById('regForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (!(value instanceof File)) {
                    data[key] = value;
                }
            }

            data.state_code = stateCodes[data.state] || '';
            data.lga_code = data.lga.split('-')[0]?.toUpperCase() || '';

            const year = new Date().getFullYear();
            const prefix = `APSG/${data.state_code}/${data.lga_code}/${year}/`;

            // Get next sequence
            let seq = 1;
            const { data: existing, error: qError } = await supabase
                .from('members')
                .select('reg_number')
                .like('reg_number', `${prefix}%`)
                .order('reg_number', { ascending: false })
                .limit(1);
            if (qError) {
                console.error('Query error:', qError);
                alert('Error generating registration number.');
                return;
            }
            if (existing && existing.length > 0) {
                const lastNum = parseInt(existing[0].reg_number.split('/')[4], 10);
                if (!isNaN(lastNum)) seq = lastNum + 1;
            }
            data.reg_number = `${prefix}${seq.toString().padStart(6, '0')}`;

            // Handle file uploads
            const pvcFile = formData.get('pvc_upload');
            let pvcPath = null;
            if (pvcFile && pvcFile.name) {
                const pvcFileName = `${Date.now()}_${pvcFile.name}`;
                const { error: pvcError } = await supabase.storage.from('uploads').upload(pvcFileName, pvcFile);
                if (pvcError) {
                    console.error('PVC upload error:', pvcError);
                    alert('Error uploading PVC file.');
                    return;
                }
                const { data: pvcUrlData } = supabase.storage.from('uploads').getPublicUrl(pvcFileName);
                pvcPath = pvcUrlData.publicUrl;
            }

            const apcFile = formData.get('apc_upload');
            let apcPath = null;
            if (apcFile && apcFile.name) {
                const apcFileName = `${Date.now()}_${apcFile.name}`;
                const { error: apcError } = await supabase.storage.from('uploads').upload(apcFileName, apcFile);
                if (apcError) {
                    console.error('APC upload error:', apcError);
                    alert('Error uploading APC card file.');
                    return;
                }
                const { data: apcUrlData } = supabase.storage.from('uploads').getPublicUrl(apcFileName);
                apcPath = apcUrlData.publicUrl;
            }

            data.pvc_upload_path = pvcPath;
            data.apc_upload_path = apcPath;

            const { error } = await supabase.from('members').insert([data]);
            if (error) {
                console.error('Insert error:', error);
                alert('Error submitting registration.');
            } else {
                alert(`Registration submitted successfully! Your registration number is ${data.reg_number}`);
                form.reset();
            }
        });
    </script>
</body>
</html>