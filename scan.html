<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APSG Event Guest Validation - 12 February 2027</title>
    
    <!-- Bootstrap 5 CDN for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
   <style>
        body {
            background: linear-gradient(to bottom, #f8f9fa, #e8f5e8);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        .header img {
            max-width: 140px;
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-family: 'Playfair Display', serif;
            color: #006400;
            margin-top: 15px;
            font-size: 2.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header p {
            font-family: 'Cormorant Garamond', serif;
            font-style: italic;
            font-size: 1.4rem;
            color: #555;
        }
        #reader {
            max-width: 600px;
            margin: 0 auto 30px;
            border: 4px solid #d4af37;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(212,175,55,0.3);
            display: none; /* Hidden until camera starts */
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        #startButton {
            background: linear-gradient(to right, #006400, #008000);
            border: none;
            padding: 15px 40px;
            font-size: 1.4rem;
            box-shadow: 0 8px 20px rgba(0,100,0,0.3);
        }
        #startButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0,100,0,0.4);
        }
        .status-msg {
            text-align: center;
            font-size: 1.2rem;
            color: #555;
            margin: 20px 0;
            min-height: 40px;
        }
        .result {
            max-width: 600px;
            margin: 30px auto;
            padding: 60px 40px;
            text-align: center;
            border-radius: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f9f7f3 100%);
            box-shadow: 0 30px 80px rgba(212,175,55,0.4), inset 0 0 30px rgba(255,255,255,0.6);
            border: 5px double #d4af37;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.6s ease-out;
        }
        .result.show {
            opacity: 1;
            transform: scale(1);
        }
        .result::before {
            content: '';
            position: absolute;
            top: -60%;
            left: -60%;
            width: 220%;
            height: 220%;
            background: radial-gradient(circle, rgba(212,175,55,0.18) 0%, transparent 70%);
            opacity: 0.7;
            animation: rotateGlow 28s linear infinite;
            pointer-events: none;
        }
        .result::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,100,0,0.12) 0%, transparent 70%);
            opacity: 0.5;
            animation: rotateGlowReverse 32s linear infinite;
            pointer-events: none;
        }
        @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes rotateGlowReverse { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
        .result i {
            font-size: 8.5rem;
            margin-bottom: 40px;
            animation: luxuryPulse 1.8s ease-in-out infinite;
            text-shadow: 0 0 40px rgba(212,175,55,0.8);
        }
        @keyframes luxuryPulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        .success i { color: #d4af37; }
        .error i { color: #dc3545; }
        .result-title {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            color: #006400;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        .guest-info {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            color: #006400;
            margin: 20px 0;
            text-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .welcome-msg {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-style: italic;
            color: #333;
        }
        footer {
            background: linear-gradient(to right, #006400, #008000);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 60px;
            font-size: 1rem;
        }
        /* Mobile Optimization */
        @media (max-width: 576px) {
            .header h1 { font-size: 2.2rem; }
            .header p { font-size: 1.2rem; }
            .result { padding: 50px 30px; }
            .result i { font-size: 6.5rem; }
            .result-title { font-size: 2.5rem; }
            .guest-info { font-size: 2.2rem; }
            .welcome-msg { font-size: 1.6rem; }
            #startButton { font-size: 1.2rem; padding: 12px 30px; }
        }
    </style>
</head>
<body>
    <audio id="vipSound" src="assets/sounds/vip-chime.mp3" preload="auto"></audio>

    <div class="container my-5">
        <div class="header">
            <img src="assets/images/apsg.png" alt="APSG Logo">
            <h1>APC Progressive Support Group</h1>
            <p>2027 and Beyond</p>
            <h2 class="mt-3 text-green">Event: 12 February 2027</h2>
        </div>

        <p class="text-center fs-4 mb-4 text-muted">
            Scan guest QR code to validate entry
        </p>

        <div id="reader"></div>

        <div id="result" class="text-center">
            <p class="ready-text">Start scanning to validate guests. Ready for next guest.</p>
        </div>

        <div class="text-center mt-4">
            <button id="startBtn" class="btn btn-primary btn-lg">Start Camera Scanner</button>
            <button id="stopBtn" class="btn btn-danger btn-lg" style="display:none;">Stop Scanner</button>
        </div>

        <div class="file-upload text-center">
            <h5>Or upload QR code image</h5>
            <input type="file" id="qrInputFile" accept="image/*" class="form-control w-50 mx-auto">
        </div>
    </div>

    <script>
        const scanner = new Html5Qrcode("reader");
        const resultDiv = document.getElementById("result");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const vipSound = document.getElementById("vipSound");

        const config = {
            fps: 10,
            qrbox: { width: 300, height: 300 },
            aspectRatio: 1.0,
            facingMode: "environment" // Prefer back camera
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(decodedText) {
            // Play VIP chime
            vipSound.play().catch(err => console.log("Audio error:", err));

            // Detect if it's a URL
            const isUrl = /^https?:\/\//i.test(decodedText.trim());
            const guestInfo = isUrl 
                ? `<a href="${decodedText}" target="_blank" class="link-primary fs-3">${decodedText}</a>`
                : `<span class="fs-3">${escapeHtml(decodedText)}</span>`;

            resultDiv.innerHTML = `
                <div class="alert alert-success p-5 shadow-lg">
                    <h1 class="display-4 text-success mb-4">ACCESS GRANTED</h1>
                    <p class="lead">Welcome to the event!</p>
                    <p><strong>Guest Info:</strong><br>${guestInfo}</p>
                </div>
            `;

            // Clear after 10 seconds to prepare for next guest
            setTimeout(() => {
                resultDiv.innerHTML = '<p class="ready-text">Ready for next guest.</p>';
            }, 10000);
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan success: ${decodedText}`);
            showSuccess(decodedText);
            // Do NOT stop scanning - continue for multiple guests
        }

        function onScanError(error) {
            // Silent errors (common during scanning)
            // console.warn(`Scan error: ${error}`);
        }

        // Camera scanner
        startBtn.addEventListener("click", () => {
            scanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                startBtn.style.display = "none";
                stopBtn.style.display = "inline-block";
                resultDiv.innerHTML = '<p class="ready-text">Scanning... Point camera at QR code.</p>';
            }).catch(err => {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${err}<br>Allow camera access and try again.</div>`;
            });
        });

        stopBtn.addEventListener("click", () => {
            scanner.stop().then(() => {
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                resultDiv.innerHTML = '<p class="ready-text">Scanner stopped. Ready for next guest.</p>';
            });
        });

        // File upload scanner
        document.getElementById('qrInputFile').addEventListener('change', e => {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];
            
            resultDiv.innerHTML = '<p class="ready-text">Processing uploaded image...</p>';
            
            Html5Qrcode.getCameras().catch(() => {
                // If no camera, still allow file scan
            });

            scanner.scanFile(file, true)
                .then(decodedText => {
                    onScanSuccess(decodedText);
                })
                .catch(err => {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error scanning image: ${err}</div>`;
                });
        });
    </script>

    <div class="container mt-5">
        <p class="text-center text-muted small">
            Note: Camera access requires HTTPS or localhost. On mobile, use back camera for best results.<br>
            Replace <code>assets/images/apsg.png</code> and <code>assets/sounds/vip-chime.mp3</code> with your actual files.
        </p>
    </div>
</body>
</html>