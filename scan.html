<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APSG Premium Check-In Scanner</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<!-- Supabase -->
<script type="module" src="supabase-client.js"></script>

<style>
body {
  background: linear-gradient(to bottom, #f8f9fa, #e8f5e8);
  font-family: 'Roboto', sans-serif;
  min-height: 100vh;
}
.header-bg {
  background: linear-gradient(to right, #006400, #008000);
  color: white;
}
.scanner-container {
  max-width: 600px;
  margin: 40px auto;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  position: relative;
}
#reader {
  width: 100%;
}
.overlay-result {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.96);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 10;
}
.overlay-result i {
  font-size: 5rem;
  margin-bottom: 15px;
}
.success i { color: #28a745; }
.error i { color: #dc3545; }
</style>
</head>

<body>

<header class="header-bg py-5 text-center">
  <h1 class="display-4">APSG Premium Scanner</h1>
  <p class="fs-4">Inauguration Event • 12 February 2026</p>
</header>

<div class="container">

<div class="scanner-container">
  <div id="reader"></div>

  <div id="overlayResult" class="overlay-result d-flex">
    <div>
      <div id="overlayIcon"></div>
      <h3 id="overlayTitle"></h3>
      <p id="overlayMessage" class="fs-4"></p>
    </div>
  </div>
</div>

</div>

<footer class="text-center py-4 bg-success text-white">
© 2026 APC Progressive Support Group Nigeria
</footer>

<script type="module">
/* ===============================
   SUPABASE + AUTH CHECK
================================ */
const supabase = window.supabase;
if (!supabase) {
  alert("Supabase client not loaded");
  throw new Error("Supabase missing");
}

const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  document.body.innerHTML = `
    <div class="container text-center mt-5">
      <h1 class="text-danger"><i class="fas fa-lock"></i> Access Restricted</h1>
      <p class="fs-4">Authorized APSG staff only.</p>
    </div>`;
  throw new Error("Not authenticated");
}

/* ===============================
   UI HELPERS
================================ */
function showResult(success, title, message, confettiOn = true) {
  const overlay = document.getElementById("overlayResult");
  const icon = document.getElementById("overlayIcon");

  icon.className = success ? "success" : "error";
  icon.innerHTML = success
    ? '<i class="fas fa-check-circle"></i>'
    : '<i class="fas fa-times-circle"></i>';

  document.getElementById("overlayTitle").textContent = title;
  document.getElementById("overlayMessage").innerHTML = message;

  overlay.style.display = "flex";

  if (success && confettiOn) {
    confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
    if (navigator.vibrate) navigator.vibrate(200);
  } else if (!success && navigator.vibrate) {
    navigator.vibrate([200, 100, 200]);
  }

  setTimeout(() => overlay.style.display = "none", 5000);
}

/* ===============================
   QR SCANNER SETUP (SAFE)
================================ */
const html5QrCode = new Html5Qrcode("reader");
let isProcessing = false;

async function startScanner() {
  try {
    // Try environment camera first (mobile)
    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 12, qrbox: 360 },
      decoded => handleScan(decoded),
      () => {}
    );
  } catch (err) {
    console.warn("Environment camera failed, falling back:", err);
    try {
      // Fallback to default/user camera
      await html5QrCode.start(
        { facingMode: "user" },
        { fps: 12, qrbox: 360 },
        decoded => handleScan(decoded),
        () => {}
      );
    } catch (finalErr) {
      console.error("Camera unavailable:", finalErr);
      document.getElementById("reader").innerHTML = `
        <div class="alert alert-warning text-center p-4">
          <i class="fas fa-camera-slash fa-2x mb-3"></i><br>
          Camera not available on this device.<br>
          Use a mobile phone or enable permissions.
        </div>`;
    }
  }
}

startScanner();

/* ===============================
   SCAN HANDLER
================================ */
async function handleScan(decodedText) {
  if (isProcessing) return;
  isProcessing = true;
  html5QrCode.pause();

  try {
    let payload;
    try {
      payload = JSON.parse(decodedText);
    } catch {
      showResult(false, "INVALID QR", "Unrecognized QR format.");
      return;
    }

    if (payload.event !== "APSG-INAUG-2026" || !payload.name) {
      showResult(false, "INVALID QR", "QR code is not valid for this event.");
      return;
    }

    const guestName = payload.name.trim();

    const { data: guest } = await supabase
      .from("vip_guests")
      .select("guest_name")
      .ilike("guest_name", guestName)
      .single();

    if (!guest) {
      showResult(false, "NOT ON LIST", `<strong>${guestName}</strong> is not registered.`);
      return;
    }

    const today = new Date();
    today.setHours(0,0,0,0);

    const { data: existing } = await supabase
      .from("checkins")
      .select("id")
      .eq("guest_name", guest.guest_name)
      .gte("checkin_time", today.toISOString());

    if (existing?.length) {
      showResult(true, "ALREADY CHECKED IN", guest.guest_name, false);
      return;
    }

    await supabase.from("checkins").insert({
      guest_name: guest.guest_name
    });

    showResult(true, "ACCESS GRANTED", `<strong>${guest.guest_name}</strong><br>Welcome!`);

  } catch (err) {
    console.error(err);
    showResult(false, "ERROR", "Unexpected system error.");
  } finally {
    setTimeout(() => {
      isProcessing = false;
      html5QrCode.resume().catch(() => {});
    }, 5000);
  }
}
</script>

</body>
</html>
